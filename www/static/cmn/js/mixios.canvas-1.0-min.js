var mixios=mixios||{};mixios.getType=function(b){var a=typeof(b);if(a=="object"&&(b instanceof Array)){a="array";}return a;};mixios.hitch=function(a,c){var b;if(typeof c=="string"){b=a[c];}else{b=c;}return function(){return b.apply(a,arguments);};};mixios.DateFormat=function(e,a){var c={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};if(/(y+)/.test(a)){a=a.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length));}for(var b in c){if(new RegExp("("+b+")").test(a)){a=a.replace(RegExp.$1,(RegExp.$1.length==1)?(c[b]):(("00"+c[b]).substr((""+c[b]).length)));}}return a;};mixios.Logger=function(a){this.enabled=a||true;var b=window.console&&console.debug;this.debug=function(c){if(this.enabled&&b){console.debug(c);}return this;};this.error=function(c){if(this.enabled&&b){console.error(c);}return this;};};mixios.application=mixios.application||{};mixios.application.newCanvas=function(b,a){return new mixios.Canvas(b,a);};mixios.Canvas=function(b,a){this.version="1.1.0";this.setHost(b);this.appName_=a.toLowerCase();this.appId_=0;this.appSignature_="";this.logger=new mixios.Logger(false);this.size_={width:"100%",height:"800"};this.ownerId_=0;this.viewerId_=0;this.nonce_="";this.isUpdated_=false;this.isGetViewer=true;this.isGetOwner=true;this.runUrl_=this.host_+"/index/run";this.staticHost_="http://static.mixi.communityfactory.net";this.mixiHost_="http://mixi.jp";this.checkUrl_=this.host_+"/callback/checkstatus";this.inviteCallBackUrl_=this.host_+"/callback/invite";this.activityCallBackUrl_=this.host_+"/callback/activity";this.loadingImgSrc_=this.staticHost_+"/cmn/img/loading/loader.gif";this.containerId_="canvas_container";this.childIframeId_="content_iframe";this.init_();};mixios.Canvas.prototype.getHost=function(){return this.host_;};mixios.Canvas.prototype.setHost=function(a){if(a.charAt(a.length-1)=="/"){a=a.substr(0,a.length-1);}this.host_=a;return this;};mixios.Canvas.prototype.getStaticHost=function(){return this.staticHost_;};mixios.Canvas.prototype.setStaticHost=function(a){this.staticHost_=a;return this;};mixios.Canvas.prototype.getAppName=function(){return this.appName_;};mixios.Canvas.prototype.getAppId=function(){return this.appId_;};mixios.Canvas.prototype.setAppSignature=function(a){this.appSignature_=a;return this;};mixios.Canvas.prototype.enableDebug=function(a){this.logger.enabled=a;return this;};mixios.Canvas.prototype.getSize=function(){return this.size_;};mixios.Canvas.prototype.setSize=function(a){this.size_=a;return this;};mixios.Canvas.prototype.setHeight=function(a){this.size_.height=""+a;return this;};mixios.Canvas.prototype.getOwnerId=function(){return this.ownerId_;};mixios.Canvas.prototype.getViewerId=function(){return this.viewerId_;};mixios.Canvas.prototype.isOwner=function(){return this.viewerId_==this.ownerId_;};mixios.Canvas.prototype.getNonce=function(){return this.nonce_;};mixios.Canvas.prototype.setRunUrl=function(a){if(a.indexOf("http://")==-1){a=this.host_+a;}this.runUrl_=a;return this;};mixios.Canvas.prototype.getMixiHost=function(){return this.mixiHost_;};mixios.Canvas.prototype.setLoadingImgSrc=function(a){if(a.indexOf("http://")==-1){a=this.host_+a;}this.loadingImgSrc_=a;return this;};mixios.Canvas.prototype.getContainerId=function(){return this.containerId_;};mixios.Canvas.prototype.setContainerId=function(a){this.containerId_=a;return this;};mixios.Canvas.prototype.getContainerUrl=function(){var a=window.location.href;return a.substr(0,a.indexOf("#"));};mixios.Canvas.prototype.isRpcMode=function(){var a=this.getParam("rpc_mode");if(a){return true;}return false;};mixios.Canvas.prototype.getRunAppliUrl=function(){return document.referrer;};mixios.Canvas.prototype.getJoinUrl=function(){return this.mixiHost_+"/join_appli.pl?id="+this.appId_;};mixios.Canvas.prototype.preLoadImage=function(b){var g=document;if(g.images){if(!g.MM_p){g.MM_p=new Array();}var f,e=g.MM_p.length,c=b;for(f=0;f<c.length;f++){if(c[f].indexOf("#")!=0){g.MM_p[e]=new Image;g.MM_p[e++].src=c[f];}}}};mixios.Canvas.prototype.start=function(){if(this.isRpcMode()){var a=location.href,c=a.substr(a.indexOf("#")+1).split("&"),b,d;try{b=c[0]===".."?parent.parent:parent.frames[c[0]];d=b.gadgets.rpc.receive;}catch(f){}d&&d(c);}else{this.preLoadImage([this.loadingImgSrc_]);gadgets.util.registerOnLoadHandler(mixios.hitch(this,this.onload_));}};mixios.Canvas.prototype.checkStatus=function(){var params={};params[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.POST;params[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON;params[gadgets.io.RequestParameters.AUTHORIZATION]=gadgets.io.AuthorizationType.SIGNED;var post_data={version:this.version,app_name:this.appName_,app_signature:this.appSignature_,view:"canvas",request_nonce:1};params[gadgets.io.RequestParameters.POST_DATA]=gadgets.io.encodeValues(post_data);var self=this;gadgets.io.makeRequest(this.checkUrl_,function(response){var status=response.data;if(status){if(status.code==1){self.nonce_=status.nonce||status.html;if(status.parameters){self.appId_=status.parameters.app_id;self.ownerId_=status.parameters.owner_id;self.viewerId_=status.parameters.viewer_id;if(self.isOwner()){self.isGetOwner=false;}}if(status.isUpdated){self.isUpdated_=(status.isUpdated=="true");}if(self.isUpdated_){self.submit_(null,null);}else{self.getData();}}else{var container=document.getElementById(self.getContainerId());if(container){container.innerHTML=status.html;}if(status.script){eval(status.script);}}}},params);};mixios.Canvas.prototype.createFormHtml=function(c,b,a){var d='<form name="mainform" id="mainform" method="post" accept-charset="utf-8" action="'+c+'">';d+='<input type="hidden" name="version" value="'+this.version+'"/>';d+='<input type="hidden" name="nonce" value="'+this.getNonce()+'"/>';d+='<input type="hidden" name="container_type" value="'+this.getContainerType()+'"/>';d+='<input type="hidden" name="windomain" value="'+this.getParam("parent")+'"/>';d+='<input type="hidden" name="top_url" value="'+this.getRunAppliUrl()+'"/>';d+='<input type="hidden" name="mixi_platform_api_url" value="'+this.getContainerUrl()+'"/>';if(b){d+='<input type="hidden" name="viewer_info" value=\''+gadgets.json.stringify(b)+"'/>";}if(a){d+='<input type="hidden" name="owner_info" value=\''+gadgets.json.stringify(a)+"'/>";}d+="</form>";return d;};mixios.Canvas.prototype.extractIFrameBody=function(a){var b=null;if(a.contentDocument){b=a.contentDocument;}else{if(a.contentWindow){b=a.contentWindow.document;}else{if(a.document){b=a.document;}else{return null;}}}if(b){b.open();b.write('<div align="center" style="margin-top:200px;"><img src="'+this.loadingImgSrc_+'" id="loadingImg" /></div>');b.close();}return b.body;};mixios.Canvas.prototype.onLoadData_=function(c){var e;if(this.isGetViewer){e=c.get("viewer_data");if(e.hadError()){this.logger.error("get viewer data error: "+e.getErrorMessage());return;}this.viewer_=e.getData();var f=this.viewer_.getField(opensocial.Person.Field.HAS_APP);if(f!="true"){window.top.location.href=this.getJoinUrl();return;}e=c.get("viewer_friends_data");if(e.hadError()){this.logger.error("get viewer friends data error: "+e.getErrorMessage());return;}this.viewerFriends_=e.getData();}if(this.isGetOwner){e=c.get("owner_data");if(e.hadError()){this.logger.error("get owner data error: "+e.getErrorMessage());return;}this.owner_=e.getData();e=c.get("owner_friends_data");if(e.hadError()){this.logger.error("get owner friends data error: "+e.getErrorMessage());return;}this.ownerFriends_=e.getData();}var b=null;if(this.isGetViewer){var d=[];if(this.isOwner()){d=this.getFriends(this.viewerFriends_);}b={user:this.getUser(this.viewer_),friends:d};}var a=null;if(this.isGetOwner){a={user:this.getUser(this.owner_),friends:this.getFriends(this.ownerFriends_)};}this.submit_(b,a);};mixios.Canvas.prototype.submit_=function(l,b){var j=this.childIframeId_;var f=this.getSize();var g=this.createFrameElement(j,f);var e=document.getElementById(this.containerId_);e.innerHTML="";e.appendChild(g);var k=document.getElementById(j);var h=this.extractIFrameBody(k);var a=this.runUrl_;var i=gadgets.views.getParams();for(var d in i){if(i.hasOwnProperty(d)){a=this.appendParameterToURL(a,d,i[d]);}}h.innerHTML=this.createFormHtml(a,l,b);var c=h.firstChild;c.submit();};mixios.Canvas.prototype.getData=function(){var e={};e[opensocial.DataRequest.PeopleRequestFields.PROFILE_DETAILS]=[opensocial.Person.Field.PROFILE_URL,mixi.PersonField.BLOOD_TYPE,opensocial.Person.Field.HAS_APP,opensocial.Person.Field.ADDRESSES,opensocial.Person.Field.AGE,opensocial.Person.Field.DATE_OF_BIRTH,opensocial.Person.Field.GENDER];var c=opensocial.newDataRequest();if(this.isGetViewer){c.add(c.newFetchPersonRequest(opensocial.IdSpec.PersonId.VIEWER,e),"viewer_data");}if(this.isGetOwner){c.add(c.newFetchPersonRequest(opensocial.IdSpec.PersonId.OWNER,e),"owner_data");}e[opensocial.DataRequest.PeopleRequestFields.MAX]=1000;if(this.isGetViewer){var a={};a[opensocial.IdSpec.Field.USER_ID]=opensocial.IdSpec.PersonId.VIEWER;a[opensocial.IdSpec.Field.GROUP_ID]="FRIENDS";var d=opensocial.newIdSpec(a);c.add(c.newFetchPeopleRequest(d,e),"viewer_friends_data");}if(this.isGetOwner){var b={};b[opensocial.IdSpec.Field.USER_ID]=opensocial.IdSpec.PersonId.OWNER;b[opensocial.IdSpec.Field.GROUP_ID]="FRIENDS";var f=opensocial.newIdSpec(b);c.add(c.newFetchPeopleRequest(f,e),"owner_friends_data");}c.send(mixios.hitch(this,this.onLoadData_));};mixios.Canvas.prototype.getUser=function(c){var g={id:c.getId(),displayName:c.getDisplayName().replace(/&/g,"&amp;"),thumbnailUrl:c.getField(opensocial.Person.Field.THUMBNAIL_URL),profileUrl:c.getField(opensocial.Person.Field.PROFILE_URL),hasApp:c.getField(opensocial.Person.Field.HAS_APP)};var f=c.getField(mixi.PersonField.BLOOD_TYPE);var a=c.getField(opensocial.Person.Field.ADDRESSES);var b=c.getField(opensocial.Person.Field.AGE);var d=c.getField(opensocial.Person.Field.DATE_OF_BIRTH);var e=c.getField(opensocial.Person.Field.GENDER);if(f){g.bloodType=f;}if(a){g.address=a[0].getField(opensocial.Address.Field.UNSTRUCTURED_ADDRESS);}if(b){g.age=b;}if(d){g.dateOfBirth=mixios.DateFormat(d,"yyyy-MM-dd");}if(e){g.gender=e.getKey();}return g;};mixios.Canvas.prototype.getFriends=function(k){var b=[];var c=0;var a,g,e,h,j,d,f;k.each(function(i){g=i.getDisplayName();if(g){b[c]={id:i.getId(),displayName:g.replace(/&/g,"&amp;"),thumbnailUrl:i.getField(opensocial.Person.Field.THUMBNAIL_URL),profileUrl:i.getField(opensocial.Person.Field.PROFILE_URL),hasApp:i.getField(opensocial.Person.Field.HAS_APP)};e=i.getField(mixi.PersonField.BLOOD_TYPE);h=i.getField(opensocial.Person.Field.ADDRESSES);j=i.getField(opensocial.Person.Field.AGE);d=i.getField(opensocial.Person.Field.DATE_OF_BIRTH);f=i.getField(opensocial.Person.Field.GENDER);if(e){b[c]["bloodType"]=e;}if(h){b[c]["address"]=h[0].getField(opensocial.Address.Field.UNSTRUCTURED_ADDRESS);}if(j){b[c]["age"]=j;}if(d){b[c]["dateOfBirth"]=mixios.DateFormat(d,"yyyy-MM-dd");}if(f){b[c]["gender"]=f.getKey();}c++;}});return b;};mixios.Canvas.prototype.appendParameterToURL=function(b,a,c){if(b.indexOf("?")==-1){return b+"?"+a+"="+encodeURIComponent(c);}else{return b+"&"+a+"="+encodeURIComponent(c);}};mixios.Canvas.prototype.createFrameElement=function(c,b){var a=document.createElement("iframe");a.setAttribute("id",c);a.setAttribute("name",c);a.frameBorder=0;a.setAttribute("scrolling","no");a.setAttribute("align","middle");a.style.height=b.height;a.style.width=b.width;return a;};mixios.Canvas.prototype.getContainerType=function(){var a=this.getParam("container");if(a.indexOf("mixi")!=-1){a="mixi";}return a;};mixios.Canvas.prototype.getParam=function(a){return _args()[a];};mixios.Canvas.prototype.createContainerContent=function(){var c=document.getElementById(this.containerId_);if(!c){var a=document.createElement("div");a.setAttribute("id",this.containerId_);var b=document.createElement("div");b.setAttribute("align","center");b.style.marginTop=200;var d=document.createElement("img");d.setAttribute("id","loadingImg");d.setAttribute("src",this.loadingImgSrc_);b.appendChild(d);a.appendChild(b);document.body.appendChild(a);}};mixios.Canvas.prototype.onload_=function(){if(document.all){document.body.setAttribute("scroll","no");}else{document.body.style.overflow="hidden";}this.createContainerContent();gadgets.window.adjustHeight(this.getSize().height);this.checkStatus();};mixios.Canvas.prototype.init_=function(){gadgets.rpc.register("remote_adjustHeight",mixios.hitch(this,this.adjustHeight));gadgets.rpc.register("remote_requestExternalNavigateTo",mixios.hitch(this,this.requestExternalNavigateTo));gadgets.rpc.register("remote_postActivity",mixios.hitch(this,this.postActivity));gadgets.rpc.register("remote_postActivityWithPic",mixios.hitch(this,this.postActivityWithPic));gadgets.rpc.register("remote_invite",mixios.hitch(this,this.invite));};mixios.Canvas.prototype.adjustHeight=function(a){gadgets.window.adjustHeight(a);this.size_.height=a;var b=document.getElementById(this.childIframeId_);if(b){b.style.height=a+"px";}};mixios.Canvas.prototype.requestExternalNavigateTo=function(a){mixi.util.requestExternalNavigateTo(a);};mixios.Canvas.prototype.postActivity=function(f,a){var e={};e[opensocial.Activity.Field.TITLE]=f;if(a){var c=mixios.getType(a);if(c=="string"||c=="array"){if(c=="string"){a=a.split(",");}e[mixi.ActivityField.RECIPIENTS]=a;}}var d=opensocial.newActivity(e);var b=this;opensocial.requestCreateActivity(d,opensocial.CreateActivityPriority.HIGH,function(g){if(g.hadError()){b.logger.error("postActivity: ["+g.getErrorCode()+"] "+g.getErrorMessage());return;}var h=a?a.join(","):"";b.activityCallBack(h);});};mixios.Canvas.prototype.postActivityWithPic=function(h,f,a,b){var i={};i[opensocial.MediaItem.Field.TYPE]=opensocial.MediaItem.Type.IMAGE;a=a||"image/jpeg";var e=opensocial.newMediaItem(a,f,i);var d={};d[opensocial.Activity.Field.TITLE]=h;d[opensocial.Activity.Field.MEDIA_ITEMS]=[e];if(b){var g=mixios.getType(b);if(g=="string"||g=="array"){if(g=="string"){b=b.split(",");}d[mixi.ActivityField.RECIPIENTS]=b;}}var c=opensocial.newActivity(d);var j=this;opensocial.requestCreateActivity(c,opensocial.CreateActivityPriority.HIGH,function(k){if(k.hadError()){j.logger.error("postActivity: ["+k.getErrorCode()+"] "+k.getErrorMessage());return;}var l=b?b.join(","):"";j.activityCallBack(l);});};mixios.Canvas.prototype.activityCallBack=function(b){var d={};d[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.POST;d[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.TEXT;d[gadgets.io.RequestParameters.AUTHORIZATION]=gadgets.io.AuthorizationType.SIGNED;var c={recipientIds:b};d[gadgets.io.RequestParameters.POST_DATA]=gadgets.io.encodeValues(c);var a=this;gadgets.io.makeRequest(this.activityCallBackUrl_,function(e){a.logger.debug("activityCallBack: "+e.text);},d);};mixios.Canvas.prototype.invite=function(c){var a=c||null;var d=opensocial.newMessage("your friend would like you to intall this application.");var b=this;opensocial.requestShareApp(a,d,function(e){var f=e.getErrorCode();if(e.hadError()&&f!=200){b.logger.error("requestShareApp: ["+e.getErrorCode()+"] "+e.getErrorMessage());return;}var h=e.getData();if(h){var g=h.recipientIds;if(g&&g.length>0){b.inviteCallBack(g.join(","));}}});};mixios.Canvas.prototype.inviteCallBack=function(b){var d={};d[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.POST;d[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.TEXT;d[gadgets.io.RequestParameters.AUTHORIZATION]=gadgets.io.AuthorizationType.SIGNED;var c={recipientIds:b};d[gadgets.io.RequestParameters.POST_DATA]=gadgets.io.encodeValues(c);var a=this;gadgets.io.makeRequest(this.inviteCallBackUrl_,function(e){a.logger.debug("inviteCallBack: "+e.text);},d);};