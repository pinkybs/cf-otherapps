/*
 * Mixi Opensocial JavaScript Library For Gadget
 * Version: 1.0.0
 *
 * Copyright (c) 2009 CommunityFactory.com
 */

var mixios=mixios||{};mixios.getType=function(b){var a=typeof(b);if(a=="object"&&(b instanceof Array)){a="array";}return a;};mixios.hitch=function(a,c){var b;if(typeof c=="string"){b=a[c];}else{b=c;}return function(){return b.apply(a,arguments);};};mixios.Logger=function(a){this.enabled=a||true;var b=window.console&&console.debug;this.debug=function(c){if(this.enabled&&b){console.debug(c);}return this;};this.error=function(c){if(this.enabled&&b){console.error(c);}return this;};};mixios.application=mixios.application||{};mixios.application.newGadget=function(b,a){return new mixios.Gadget(b,a);};mixios.Gadget=function(b,a){this.setHost(b);this.appName_=a.toLowerCase();this.appId_=0;this.appSignature_="";this.logger=new mixios.Logger(false);this.height_=800;this.ownerId_=0;this.viewerId_=0;this.isGetOwnerData=false;this.isGetViewerData=false;this.isGetOwnerFriendsData=false;this.isGetViewerFriendsData=false;this.mixiHost_="http://mixi.jp";this.checkUrl_=this.host_+"/callback/checkstatus";this.activityCallBackUrl_=this.host_+"/callback/activity";this.staticHost_="http://static.mixi.communityfactory.net";this.loadingImgSrc_=this.staticHost_+"/cmn/img/loading/gadget_loader.gif";this.containerId_="gadget_container";this.onLoadHandlers_=[];this.postLoadDataHandlers_=[];this.init_();};mixios.Gadget.prototype.getHost=function(){return this.host_;};mixios.Gadget.prototype.setHost=function(a){if(a.charAt(a.length-1)=="/"){a=a.substr(0,a.length-1);}this.host_=a;return this;};mixios.Gadget.prototype.getStaticHost=function(){return this.staticHost_;};mixios.Gadget.prototype.setStaticHost=function(a){this.staticHost_=a;return this;};mixios.Gadget.prototype.getHeight=function(){return this.height_;};mixios.Gadget.prototype.setHeight=function(a){this.height_=a;return this;};mixios.Gadget.prototype.getAppId=function(){return this.appId_;};mixios.Gadget.prototype.setAppSignature=function(a){this.appSignature_=a;return this;};mixios.Gadget.prototype.enableDebug=function(a){this.logger.enabled=a;return this;};mixios.Gadget.prototype.getOwnerId=function(){return this.ownerId_;};mixios.Gadget.prototype.getViewerId=function(){return this.viewerId_;};mixios.Gadget.prototype.getMixiHost=function(){return this.mixiHost_;};mixios.Gadget.prototype.setLoadingImgSrc=function(a){this.loadingImgSrc_=a;return this;};mixios.Gadget.prototype.getContainerId=function(){return this.containerId_;};mixios.Gadget.prototype.setContainerId=function(a){this.containerId_=a;return this;};mixios.Gadget.prototype.getTimestamp=function(){return(new Date()).getTime();};mixios.Gadget.prototype.isGetData=function(){return this.isGetOwnerData||this.isGetViewerData||this.isGetOwnerFriendsData||this.isGetViewerFriendsData;};mixios.Gadget.prototype.getOwner=function(){return this.owner_;};mixios.Gadget.prototype.getViewer=function(){return this.viewer_;};mixios.Gadget.prototype.getOwnerFriends=function(){return this.ownerFriends_;};mixios.Gadget.prototype.getViewerFriends=function(){return this.viewerFriends_;};mixios.Gadget.prototype.registerOnLoadHandler=function(a){this.onLoadHandlers_.push(a);return this;};mixios.Gadget.prototype.registerPostLoadDataHandler=function(a){this.postLoadDataHandlers_.push(a);return this;};mixios.Gadget.prototype.runOnLoadHandlers=function(){for(var b=0,a=this.onLoadHandlers_.length;b<a;++b){this.onLoadHandlers_[b]();}};mixios.Gadget.prototype.runPostLoadDataHandlers=function(){for(var b=0,a=this.postLoadDataHandlers_.length;b<a;++b){this.postLoadDataHandlers_[b]();}};mixios.Gadget.prototype.start=function(){gadgets.util.registerOnLoadHandler(mixios.hitch(this,this.onload_));};mixios.Gadget.prototype.checkStatus=function(){var params={};params[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.POST;params[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON;params[gadgets.io.RequestParameters.AUTHORIZATION]=gadgets.io.AuthorizationType.SIGNED;var urlParams=gadgets.util.getUrlParameters();var post_data={app_name:this.appName_,app_signature:this.appSignature_,view:urlParams.view};params[gadgets.io.RequestParameters.POST_DATA]=gadgets.io.encodeValues(post_data);var self=this;gadgets.io.makeRequest(this.checkUrl_,function(response){var status=response.data;if(status){if(status.code==1){if(status.parameters){self.appId_=status.parameters.app_id;self.ownerId_=status.parameters.owner_id;self.viewerId_=status.parameters.viewer_id;}if(self.isGetData()){self.getData();}self.runOnLoadHandlers();}else{var container=document.getElementById(self.getContainerId());if(container){container.innerHTML=status.html;}if(status.script){eval(status.script);}}}},params);};mixios.Gadget.prototype.onLoadData_=function(a){var b;if(this.isGetOwnerData){b=a.get("owner_data");if(b.hadError()){this.logger.error("get owner data error: "+b.getErrorMessage());return;}this.owner_=b.getData();}if(this.isGetViewerData){b=a.get("viewer_data");if(b.hadError()){this.logger.error("get viewer data error: "+b.getErrorMessage());return;}this.viewer_=b.getData();}if(this.isGetOwnerFriendsData){b=a.get("owner_friends_data");if(b.hadError()){this.logger.error("get owner friends data error: "+b.getErrorMessage());return;}this.ownerFriends_=b.getData();}if(this.isGetViewerFriendsData){b=a.get("viewer_friends_data");if(b.hadError()){this.logger.error("get viewer friends data error: "+b.getErrorMessage());return;}this.viewerFriends_=b.getData();}this.runPostLoadDataHandlers();};mixios.Gadget.prototype.getData=function(){var e={};e[opensocial.DataRequest.PeopleRequestFields.PROFILE_DETAILS]=[opensocial.Person.Field.PROFILE_URL,opensocial.Person.Field.HAS_APP];var c=opensocial.newDataRequest();if(this.isGetOwnerData){c.add(c.newFetchPersonRequest(opensocial.IdSpec.PersonId.OWNER,e),"owner_data");}if(this.isGetViewerData){c.add(c.newFetchPersonRequest(opensocial.IdSpec.PersonId.VIEWER,e),"viewer_data");}e[opensocial.DataRequest.PeopleRequestFields.MAX]=1000;if(this.isGetOwnerFriendsData){var b={};b[opensocial.IdSpec.Field.USER_ID]=opensocial.IdSpec.PersonId.OWNER;b[opensocial.IdSpec.Field.GROUP_ID]="FRIENDS";var f=opensocial.newIdSpec(b);c.add(c.newFetchPeopleRequest(f,e),"owner_friends_data");}if(this.isGetViewerFriendsData){var a={};a[opensocial.IdSpec.Field.USER_ID]=opensocial.IdSpec.PersonId.VIEWER;a[opensocial.IdSpec.Field.GROUP_ID]="FRIENDS";var d=opensocial.newIdSpec(a);c.add(c.newFetchPeopleRequest(d,e),"viewer_friends_data");}c.send(mixios.hitch(this,this.onLoadData_));};mixios.Gadget.prototype.adjustHeight=function(a){gadgets.window.adjustHeight(a);};mixios.Gadget.prototype.createContainerContent=function(){var c=document.getElementById(this.containerId_);if(!c){var a=document.createElement("div");a.setAttribute("id",this.containerId_);var b=document.createElement("div");b.setAttribute("align","center");b.style.marginTop=70;var d=document.createElement("img");d.setAttribute("id","loadingImg");d.setAttribute("src",this.loadingImgSrc_);b.appendChild(d);a.appendChild(b);document.body.appendChild(a);}};mixios.Gadget.prototype.onload_=function(){this.createContainerContent();gadgets.window.adjustHeight(this.getHeight());this.checkStatus();};mixios.Gadget.prototype.init_=function(){};mixios.Gadget.prototype.postActivity=function(f,a){var e={};e[opensocial.Activity.Field.TITLE]=f;if(a){var c=mixios.getType(a);if(c=="string"||c=="array"){if(c=="string"){a=a.split(",");}e[mixi.ActivityField.RECIPIENTS]=a;}}var d=opensocial.newActivity(e);var b=this;opensocial.requestCreateActivity(d,opensocial.CreateActivityPriority.HIGH,function(g){if(g.hadError()){b.logger.error("postActivity: ["+g.getErrorCode()+"] "+g.getErrorMessage());return;}var h=a?a.join(","):"";b.activityCallBack(h);});};mixios.Gadget.prototype.postActivityWithPic=function(h,f,a,b){var i={};i[opensocial.MediaItem.Field.TYPE]=opensocial.MediaItem.Type.IMAGE;a=a||"image/jpeg";var e=opensocial.newMediaItem(a,f,i);var d={};d[opensocial.Activity.Field.TITLE]=h;d[opensocial.Activity.Field.MEDIA_ITEMS]=[e];if(b){var g=mixios.getType(b);if(g=="string"||g=="array"){if(g=="string"){b=b.split(",");}d[mixi.ActivityField.RECIPIENTS]=b;}}var c=opensocial.newActivity(d);var j=this;opensocial.requestCreateActivity(c,opensocial.CreateActivityPriority.HIGH,function(k){if(k.hadError()){j.logger.error("postActivity: ["+k.getErrorCode()+"] "+k.getErrorMessage());return;}var l=b?b.join(","):"";j.activityCallBack(l);});};mixios.Gadget.prototype.activityCallBack=function(b){var d={};d[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.POST;d[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.TEXT;d[gadgets.io.RequestParameters.AUTHORIZATION]=gadgets.io.AuthorizationType.SIGNED;var c={recipientIds:b};d[gadgets.io.RequestParameters.POST_DATA]=gadgets.io.encodeValues(c);var a=this;gadgets.io.makeRequest(this.activityCallBackUrl_,function(e){a.logger.debug("activityCallBack: "+e.text);},d);};